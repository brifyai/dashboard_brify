<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico de Login - Supabase</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; text-align: center; }
        .section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px;
        }
        input { 
            width: 100%; 
            padding: 10px; 
            margin: 5px 0; 
            border: 1px solid #ccc; 
            border-radius: 4px;
            box-sizing: border-box;
        }
        button { 
            background: #007bff; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
            width: 100%;
            margin: 5px 0;
        }
        button:hover { background: #0056b3; }
        .success { color: #28a745; background: #d4edda; padding: 10px; border-radius: 4px; }
        .error { color: #dc3545; background: #f8d7da; padding: 10px; border-radius: 4px; }
        .info { color: #17a2b8; background: #d1ecf1; padding: 10px; border-radius: 4px; }
        .log { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 10px; 
            border-radius: 4px; 
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .step { margin: 10px 0; }
        .step-number { 
            background: #007bff; 
            color: white; 
            border-radius: 50%; 
            width: 25px; 
            height: 25px; 
            display: inline-block; 
            text-align: center; 
            line-height: 25px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico de Login - Supabase</h1>
        
        <div class="section">
            <h3>üìã Instrucciones de uso:</h3>
            <div class="step">
                <span class="step-number">1</span>
                <strong>Abre la consola del navegador (F12 ‚Üí Console)</strong>
            </div>
            <div class="step">
                <span class="step-number">2</span>
                <strong>Ingresa tus credenciales de Supabase</strong>
            </div>
            <div class="step">
                <span class="step-number">3</span>
                <strong>Observa los mensajes detallados en la consola</strong>
            </div>
            <div class="step">
                <span class="step-number">4</span>
                <strong>Copia los mensajes de error si los hay</strong>
            </div>
        </div>

        <div class="section">
            <h3>üîë Credenciales de Supabase:</h3>
            <div class="info">
                <strong>URL del proyecto:</strong> https://hvhmsecjrkmlqlruznfe.supabase.co<br>
                <strong>Ayuda:</strong> Si no tienes credenciales, usa el formulario de registro en la app principal
            </div>
            
            <input type="email" id="email" placeholder="tu-email@ejemplo.com" value="">
            <input type="password" id="password" placeholder="tu-contrase√±a">
        </div>

        <div class="section">
            <h3>üß™ Pruebas de Diagn√≥stico:</h3>
            
            <button onclick="diagnosticarSupabase()">1. Diagnosticar Supabase</button>
            <button onclick="probarConexion()">2. Probar Conexi√≥n</button>
            <button onclick="verificarSesion()">3. Verificar Sesi√≥n Actual</button>
            <button onclick="intentarLogin()">4. Intentar Login Manual</button>
            <button onclick="verificarUsuario()">5. Verificar Usuario en BD</button>
            <button onclick="limpiarLogs()">üóëÔ∏è Limpiar Logs</button>
        </div>

        <div class="section">
            <h3>üìä Resultados del Diagn√≥stico:</h3>
            <div id="resultados" class="log">
                <div style="color: #666;">Los resultados aparecer√°n aqu√≠...</div>
            </div>
        </div>

        <div class="section">
            <h3>üÜò Si encuentras errores:</h3>
            <div class="error">
                <strong>1.</strong> Copia TODOS los mensajes de la consola (F12 ‚Üí Console)<br>
                <strong>2.</strong> Env√≠ame los mensajes para que pueda ayudarte<br>
                <strong>3.</strong> Tambi√©n puedes ejecutar: <code>node diagnostico-autenticacion.js</code> en la terminal
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://hvhmsecjrkmlqlruznfe.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2aG1zZWNqcmttbHFscnV6bmZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3ODkxMDYsImV4cCI6MjA4MDM2NTEwNn0.zE9klNhzyoW7tDqfE-69i4crKsdtzenP0i01c5xOgE4';

        let supabase;

        function agregarLog(mensaje, tipo = 'info') {
            const resultados = document.getElementById('resultados');
            const timestamp = new Date().toLocaleTimeString();
            const color = tipo === 'success' ? '#28a745' : tipo === 'error' ? '#dc3545' : '#17a2b8';
            resultados.innerHTML += `<div style="color: ${color}; margin: 5px 0;">[${timestamp}] ${mensaje}</div>`;
            resultados.scrollTop = resultados.scrollHeight;
            
            // Tambi√©n imprimir en consola para debugging
            console.log(`[${timestamp}] ${mensaje}`);
        }

        function diagnosticarSupabase() {
            agregarLog('=== DIAGNOSTICANDO SUPABASE ===', 'info');
            
            try {
                // Verificar si Supabase est√° cargado
                if (typeof window.supabase === 'undefined') {
                    agregarLog('‚ùå Supabase no est√° cargado en window.supabase', 'error');
                    agregarLog('Intentando cargar Supabase manualmente...', 'info');
                    
                    // Cargar Supabase manualmente
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                    script.onload = () => {
                        agregarLog('‚úÖ Supabase JS cargado desde CDN', 'success');
                        inicializarSupabase();
                    };
                    script.onerror = () => {
                        agregarLog('‚ùå Error al cargar Supabase desde CDN', 'error');
                    };
                    document.head.appendChild(script);
                } else {
                    agregarLog('‚úÖ Supabase est√° disponible en window.supabase', 'success');
                    inicializarSupabase();
                }
            } catch (error) {
                agregarLog(`‚ùå Error general: ${error.message}`, 'error');
            }
        }

        function inicializarSupabase() {
            try {
                if (typeof supabase === 'undefined' && typeof window.supabase !== 'undefined') {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    agregarLog('‚úÖ Cliente Supabase inicializado', 'success');
                } else if (typeof supabase !== 'undefined') {
                    agregarLog('‚úÖ Cliente Supabase ya estaba inicializado', 'success');
                } else {
                    agregarLog('‚ùå No se pudo inicializar Supabase', 'error');
                    return;
                }
                
                // Verificar la configuraci√≥n
                agregarLog(`üì° URL: ${SUPABASE_URL}`, 'info');
                agregarLog(`üîë KEY: ${SUPABASE_ANON_KEY.substring(0, 20)}...`, 'info');
                
            } catch (error) {
                agregarLog(`‚ùå Error inicializando Supabase: ${error.message}`, 'error');
            }
        }

        async function probarConexion() {
            agregarLog('=== PROBANDO CONEXI√ìN CON SUPABASE ===', 'info');
            
            try {
                if (!supabase) {
                    agregarLog('‚ùå Supabase no est√° inicializado', 'error');
                    return;
                }

                // Probar conexi√≥n b√°sica
                const { data, error } = await supabase.from('users').select('id').limit(1);
                
                if (error) {
                    agregarLog(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                    agregarLog(`üìã C√≥digo de error: ${error.code}`, 'error');
                    if (error.details) agregarLog(`üìã Detalles: ${error.details}`, 'error');
                } else {
                    agregarLog('‚úÖ Conexi√≥n exitosa con Supabase', 'success');
                    agregarLog(`üìä Datos recibidos: ${JSON.stringify(data)}`, 'success');
                }
            } catch (error) {
                agregarLog(`‚ùå Error en prueba de conexi√≥n: ${error.message}`, 'error');
            }
        }

        async function verificarSesion() {
            agregarLog('=== VERIFICANDO SESI√ìN ACTUAL ===', 'info');
            
            try {
                if (!supabase) {
                    agregarLog('‚ùå Supabase no est√° inicializado', 'error');
                    return;
                }

                const { data, error } = await supabase.auth.getSession();
                
                if (error) {
                    agregarLog(`‚ùå Error obteniendo sesi√≥n: ${error.message}`, 'error');
                } else if (data.session) {
                    agregarLog('‚úÖ Sesi√≥n activa encontrada', 'success');
                    agregarLog(`üë§ Usuario: ${data.session.user.email}`, 'success');
                    agregarLog(`üÜî ID: ${data.session.user.id}`, 'success');
                    agregarLog(`‚è∞ Expira: ${new Date(data.session.expires_at * 1000).toLocaleString()}`, 'info');
                    
                    // Verificar metadata
                    if (data.session.user.user_metadata) {
                        agregarLog(`üìã Metadata: ${JSON.stringify(data.session.user.user_metadata)}`, 'info');
                    }
                } else {
                    agregarLog('‚ö†Ô∏è No hay sesi√≥n activa', 'info');
                    agregarLog('‚ÑπÔ∏è Necesitas iniciar sesi√≥n para acceder al dashboard', 'info');
                }
            } catch (error) {
                agregarLog(`‚ùå Error verificando sesi√≥n: ${error.message}`, 'error');
            }
        }

        async function intentarLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                agregarLog('‚ùå Por favor ingresa email y contrase√±a', 'error');
                return;
            }

            agregarLog(`=== INTENTANDO LOGIN: ${email} ===`, 'info');
            
            try {
                if (!supabase) {
                    agregarLog('‚ùå Supabase no est√° inicializado', 'error');
                    return;
                }

                agregarLog('üîê Enviando credenciales...', 'info');
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    agregarLog(`‚ùå Error en login: ${error.message}`, 'error');
                    agregarLog(`üìã C√≥digo: ${error.code}`, 'error');
                    
                    // Mensajes espec√≠ficos de error comunes
                    if (error.code === 'invalid_credentials') {
                        agregarLog('üí° Credenciales inv√°lidas - verifica email y contrase√±a', 'error');
                    } else if (error.code === 'email_not_confirmed') {
                        agregarLog('üí° Email no confirmado - revisa tu bandeja de entrada', 'error');
                    } else if (error.message.includes('Network')) {
                        agregarLog('üí° Problema de red - verifica tu conexi√≥n', 'error');
                    }
                } else if (data.session) {
                    agregarLog('‚úÖ ¬°Login exitoso!', 'success');
                    agregarLog(`üë§ Usuario: ${data.user.email}`, 'success');
                    agregarLog(`üÜî ID: ${data.user.id}`, 'success');
                    agregarLog(`‚è∞ Sesi√≥n expira: ${new Date(data.session.expires_at * 1000).toLocaleString()}`, 'info');
                    
                    // Verificar si el usuario existe en la tabla users
                    await verificarUsuarioEnBD(data.user.id);
                    
                    agregarLog('üîÑ Ahora deber√≠as ser redirigido a /admin/default', 'info');
                    agregarLog('‚ÑπÔ∏è Si no te redirige, hay un problema en el componente React', 'info');
                } else {
                    agregarLog('‚ö†Ô∏è Login completado pero sin sesi√≥n', 'info');
                    agregarLog('‚ÑπÔ∏è Esto puede indicar que el email necesita confirmaci√≥n', 'info');
                }
            } catch (error) {
                agregarLog(`‚ùå Error intentando login: ${error.message}`, 'error');
                agregarLog(`üìã Stack: ${error.stack}`, 'error');
            }
        }

        async function verificarUsuarioEnBD(userId) {
            agregarLog('=== VERIFICANDO USUARIO EN BASE DE DATOS ===', 'info');
            
            try {
                if (!supabase) {
                    agregarLog('‚ùå Supabase no est√° inicializado', 'error');
                    return;
                }

                // Verificar si el usuario existe en la tabla users
                const { data, error } = await supabase
                    .from('users')
                    .select('id, email, name, role, status, created_at')
                    .eq('id', userId)
                    .single();

                if (error) {
                    if (error.code === 'PGRST116') {
                        agregarLog('‚ö†Ô∏è Usuario no encontrado en tabla users', 'info');
                        agregarLog('üí° Se crear√° un perfil autom√°ticamente al acceder al dashboard', 'info');
                    } else {
                        agregarLog(`‚ùå Error verificando usuario: ${error.message}`, 'error');
                    }
                } else if (data) {
                    agregarLog('‚úÖ Usuario encontrado en base de datos', 'success');
                    agregarLog(`üìã Datos: ${JSON.stringify(data, null, 2)}`, 'success');
                    
                    // Verificar estado
                    if (data.status === 'active') {
                        agregarLog('‚úÖ Usuario est√° activo', 'success');
                    } else {
                        agregarLog(`‚ö†Ô∏è Usuario tiene estado: ${data.status}`, 'info');
                    }
                }
            } catch (error) {
                agregarLog(`‚ùå Error verificando usuario en BD: ${error.message}`, 'error');
            }
        }

        function limpiarLogs() {
            document.getElementById('resultados').innerHTML = '<div style="color: #666;">Logs limpiados. Listo para nueva prueba...</div>';
        }

        // Inicializar Supabase al cargar la p√°gina
        window.onload = function() {
            agregarLog('üöÄ P√°gina de diagn√≥stico cargada', 'success');
            agregarLog('üì° Configuraci√≥n de Supabase detectada', 'info');
            diagnosticarSupabase();
        };
    </script>
</body>
</html>